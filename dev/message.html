<!DOCTYPE html>
<html lang="zh_Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    @@include('./layout/head.html',{
        "title": "浪愛回家 ｜ 我的信箱"
    })
    <link rel="stylesheet" href="./css/message.css">
</head>
<body>
    @@include('./layout/header_mem.html')
    <section>
        <div id="blackListAlert" class="md-modal md-effect-1">
            <form method="POST" class="md-content">
                <p>設定為黑名單後即無法傳送私信給此用戶，並無法收到此用戶傳來的私信，是否確認將此用戶設為黑名單？</p>
                <button class="yes titleFont">確認</button>
                <button class="cancel titleFont md-close">取消</button>
            </form>
        </div>
        <div id="deleteAlert">
            <form method="POST">
                <p>刪除私信後即無法再顯示及回覆該筆私信，是否確認刪除此筆私信？</p>
                <button class="yes titleFont">確認</button>
                <button class="cancel titleFont">取消</button>
            </form>
        </div>
        <aside class="col-xl-4 col-lg-4 col-md-5 col-sm-12 col-ss-12">
            <div class="myMessage">
                <h2>我的信箱</h2>
                <span class="titleFont"></span><!--幾則未讀-->
            </div>
            <ul class="aside">
                <!-- <li class="unRead">
                    <div class="img">
                        <img src="img/message_mem_1.jpg">
                    </div>
                    <div class="text">
                        <div class="title">
                            <h4>May</h4>
                            <span class="smalltext">2020.02.24　21:09</span>
                        </div>
                        <p>Hello想請問你文章裡面分享的飼料是哪個牌子呢～～～？我家貓咪最近吃飯吃不好，想幫他換換口味</p>
                    </div> 
                </li>
                <li class="on">
                    <div class="img">
                        <img src="img/message_mem_1.jpg">
                    </div>
                    <div class="text">
                        <div class="title">
                            <h4>May</h4>
                            <span class="smalltext">2020.02.24　21:09</span>
                        </div>
                        <p>Hello想請問你文章裡面分享的飼料是哪個牌子呢～～～？我家貓咪最近吃飯吃不好，想幫他換換口味</p>
                    </div>
                </li> -->
                <!-- <li>
                    <div class="img">
                        <img src="img/message_mem_1.jpg">
                    </div>
                    <div class="text">
                        <div class="title">
                            <h4>May</h4>
                            <span class="smalltext">2020.02.24　21:09</span>
                        </div>
                        <p>Hello想請問你文章裡面分享的飼料是哪個牌子呢～～～？我家貓咪最近吃飯吃不好，想幫他換換口味</p>
                    </div>
                </li> -->
                
            </ul>
        </aside>
        <main class="col-xl-8 col-lg-8 col-md-7 col-sm-12 col-ss-12">
            <ul>
                <button class="back titleFont"></button>
                <div id="setBlackZone">
                    <button id="setting"></button>
                    <span id="setBlack">設為黑名單</span>
                </div>
                <!-- <li class="otherSide">
                    <div class="img">
                        <img src="img/message_mem_1.jpg">
                    </div>
                    <h4>May</h4>
                    <div class="text">
                        <h4>May</h4>
                        <p>Hello想請問你文章裡面分享的飼料是哪個牌子呢～～～？我家貓咪最近吃飯吃不好，想幫他換換口味</p>
                        <span class="smalltext">2020.02.24　21:09</span>
                        <button class="closeBtn"></button>
                    </div>
                </li>
                <li class="self">
                    <div class="text">
                        <p>Hello想請問你文章裡面分享的飼料是哪個牌子呢～～～？我家貓咪最近吃飯吃不好，想幫他換換口味</p>
                        <span class="smalltext">2020.02.24　21:09</span>
                        <button class="closeBtn"></button>
                    </div>
                </li> -->
                
            </ul>
            <form action="./php/message.php" method="POST" class="edit" enctype="multipart/form-data">
                <label for="upload">
                    <input type="file" id="upload" name="upload" accept="image/*">
                </label>
                <input type="text" id="inputText" name="inputText" placeholder="請輸入私信內容">
                <input type="submit" value="">
            </div>
        </main>
    </section>
    <script src="./js/heightWithoutHeader.js"></script>
    <script src="./js/hamburger.js"></script>
    <script src="./js/memberHeader.js"></script>
    <script src="./js/signInOut_mem.js"></script>
    <script>
        sectionHeight();
        window.addEventListener('resize',sectionHeight);

        let setBlackZone= document.getElementById("setBlackZone");
        let setting= document.getElementById("setting");
        let setBlack= document.getElementById("setBlack");
        let blackListAlert= document.getElementById("blackListAlert");
        let closeBtns= document.querySelectorAll('button.closeBtn');
        let deleteAlert= document.getElementById("deleteAlert");
        
        setBlackZone.style.top= document.querySelector('nav').offsetHeight + 10 + "px";
        window.addEventListener('resize',function(){
            setBlackZone.style.top= document.querySelector('nav').offsetHeight + 10 + "px";
        });
        setting.addEventListener("click",function(){
            setBlack.classList.toggle("on");
        });
        setBlack.addEventListener("click",function(){
            setBlack.classList.toggle("on");
            blackListAlert.style.display="block";
        });
        blackListAlert.querySelector('button.cancel').onclick=function(e){
            e.preventDefault();
            blackListAlert.style.display="none";
        };
        for(let i=0; i<closeBtns.length; i++){
            closeBtns[i].onclick=function(){
                deleteAlert.style.display="block";
            }
        }
        deleteAlert.querySelector('button.cancel').onclick=function(e){
            e.preventDefault();
            deleteAlert.style.display="none";
        }

        let chatRooms= document.querySelectorAll('aside ul li');
        let aside= document.querySelector('aside');
        let main= document.querySelector('main');  
        let btnBack= document.querySelector('button.back');

        function changeSide(e){
            if(document.body.clientWidth<=767){
                if(main.style.display=='none'){
                    aside.style.width= '0%';
                    main.style.display= 'block';
                    main.style.width= '100%';
                }else{
                    aside.style.width= '100%';
                    main.style.display= 'none';
                }
            }
        }

        for(let i=0; i<chatRooms.length; i++){
            chatRooms[i].addEventListener('click',changeSide);
        }
        btnBack.addEventListener('click',changeSide);

        window.addEventListener('resize',function(){
            //md
            if(document.body.clientWidth>=768 && document.body.clientWidth<=991){
                aside.style.width= 'calc(100% / 12 * 5)';
                main.style.display= 'block';
                main.style.width= 'calc(100% / 12 * 7)';

            //lg
            }else if(document.body.clientWidth>=992 && document.body.clientWidth<=1199){
                aside.style.width= 'calc(100% / 12 * 4)';
                main.style.display= 'block';
                main.style.width= 'calc(100% / 12 * 8)';

            //xl
            }else if(document.body.clientWidth>=1200){
                aside.style.width= 'calc(100% / 12 * 4)';
                main.style.display= 'block';
                main.style.width= 'calc(100% / 12 * 8)';

            //sm
            }else if(document.body.clientWidth>=576 && document.body.clientWidth<=767){
                aside.style.width= '100%';
                main.style.display= 'none';
                main.style.width= '100%';

            //ss
            }else if(document.body.clientWidth<=575){
                aside.style.width= '100%';
                main.style.display= 'none';
                main.style.width= '100%';
            }
        });

        //秀出左邊列表
        function showMsgList(xmlDoc){
            var fields= xmlDoc.documentElement.childNodes;//members>member
            for(var i=0; i<fields.length; i++){
                var li= document.createElement("li");
                li.className= "No"+fields[i].getElementsByTagName("sendMemNo")[0].firstChild.nodeValue;
                var divImg= document.createElement("div");
                divImg.className= "img";
                li.appendChild(divImg);
                var img= document.createElement("img");
                var sendMemPic= fields[i].getElementsByTagName("sendMemPic")[0].firstChild.nodeValue;
                img.src=`./img/memImg/${sendMemPic}`;//寄件人的圖片
                divImg.appendChild(img);
                var divText= document.createElement("div");
                divText.className="text";
                var divTitle= document.createElement("div");
                divTitle.className="title";
                divText.appendChild(divTitle);
                var h4= document.createElement("h4");
                var sendMemName= fields[i].getElementsByTagName("sendMemName")[0].firstChild.nodeValue;
                var h4Text= document.createTextNode(sendMemName);
                h4.appendChild(h4Text);
                var span= document.createElement("span");
                var sendTime= fields[i].getElementsByTagName("msgTime")[0].firstChild.nodeValue;
                var spanText= document.createTextNode(sendTime.split(" ")[0]+"　"+sendTime.split(" ")[1].split(":")[0]+":"+sendTime.split(" ")[1].split(":")[1]);
                span.appendChild(spanText);
                span.className="smalltext";
                divTitle.appendChild(h4);
                divTitle.appendChild(span);
                var p= document.createElement("p");
                if(fields[i].getElementsByTagName("msgText")[0].firstChild.nodeValue==""){
                    var latestMsg= sendMemName+"傳送一張圖片";
                }else{
                    var latestMsg=fields[i].getElementsByTagName("msgText")[0].firstChild.nodeValue;
                }
                var pText= document.createTextNode(latestMsg);
                p.appendChild(pText);
                divText.appendChild(p);
                li.appendChild(divText);
                var ulAside= document.querySelector("ul.aside");
                ulAside.insertBefore(li,ulAside.firstChild);
                var ulAsideLis= document.querySelectorAll(`aside ul li.No${fields[i].getElementsByTagName("sendMemNo")[0].firstChild.nodeValue}`);
                
                for(var j=0; j<ulAsideLis.length; j++){
                    ulAsideLis[j].onclick=function(e){
                        showAllMsg(this.getAttribute("class").substr(2));
                        console.log(this.getAttribute("class").substr(2));
                    }
                }
            }
        }

        //取得左邊列表
        function getMsg(){
            var xhr= new XMLHttpRequest();
            var url= "./php/LatestMessage.php";
            xhr.open("POST",url,true);
            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
            var data_info= "";
            xhr.send(data_info);
            xhr.onload=function (){
                if(xhr.status==200){
                    if(xhr.responseText.indexOf("notFound")==-1){
                        showMsgList(xhr.responseXML);
                 
                    }else{
                        alert("尚無私信內容");
                    }
                }else{
                    alert(xhr.status);
                }
            };
        }
        getMsg();

        //右邊的顯示內容
        function showPanel(xmlDoc){
            var fields= xmlDoc.documentElement.childNodes;//members>member
            for(var i=0; i<fields.length; i++){
                var li= document.createElement("li");
                var myMemNo= fields[i].getElementsByTagName("myMemNo")[0].firstChild.nodeValue;
                var sendMemNo= fields[i].getElementsByTagName("sendMemNo")[0].firstChild.nodeValue;
                console.log("myMemNo:",myMemNo,"|sendMemNo:",sendMemNo);
                if(myMemNo != sendMemNo){
                    li.className="otherSide";
                }else{
                    li.className="self";
                }
                if(li.className=="otherSide"){
                    var divImg= document.createElement("div");
                    divImg.className="img";
                    li.appendChild(divImg);
                    var img= document.createElement("img");
                    var sendMemPic= fields[i].getElementsByTagName("sendMemPic")[0].firstChild.nodeValue;
                    img.src=`./img/memImg/${sendMemPic}`;//寄件人的圖片
                    divImg.appendChild(img);
                    var h4= document.createElement("h4");
                    var sendMemName= fields[i].getElementsByTagName("sendMemName")[0].firstChild.nodeValue;
                    var h4Text= document.createTextNode(sendMemName);
                    h4.appendChild(h4Text);
                    li.appendChild(h4);
                }
                var divText= document.createElement("div");
                divText.className="text";
                li.appendChild(divText);
                if(li.className=="otherSide"){
                    var h4= document.createElement("h4");
                    var sendMemName= fields[i].getElementsByTagName("sendMemName")[0].firstChild.nodeValue;
                    var h4Text= document.createTextNode(sendMemName);
                    h4.appendChild(h4Text);
                    divText.appendChild(h4);
                }
                var p= document.createElement("p");
                var pText= fields[i].getElementsByTagName("msgText")[0].firstChild.nodeValue;
                var pNode= document.createTextNode(pText);
                p.appendChild(pNode);
                divText.appendChild(p);
                //圖片的待補充
                var span= document.createElement("span");
                span.className="smalltext";
                var msgTime= fields[i].getElementsByTagName("msgTime")[0].firstChild.nodeValue;
                var spanText= document.createTextNode(msgTime.split(" ")[0]+"　"+msgTime.split(" ")[1].split(":")[0]+":"+msgTime.split(" ")[1].split(":")[1]);
                span.appendChild(spanText);
                divText.appendChild(span);
                var button= document.createElement("button");
                button.className="closeBtn";
                divText.appendChild(button);
                var ulMain= document.querySelector('main ul');
                ulMain.appendChild(li);

            }
        }


        //按左邊列表顯示在右邊
        function showAllMsg(sendMemNo){
            var xhr= new XMLHttpRequest();
            var url= "./php/showAllMsg.php";
            xhr.open("POST",url,true);
            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
            var data_info= "sendMemNo="+sendMemNo;
            xhr.send(data_info);
            xhr.onload=function(){
                if(xhr.status==200){
                    showPanel(xhr.responseXML);
                    // alert(xhr.responseText);
                }else{
                    alert(xhr.status);
                }
            };
        }

    </script>
</body>
</html>
