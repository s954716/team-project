<!DOCTYPE html>
<html lang="zh_Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    @@include('./layout/head.html',{
        "title": "浪愛回家 ｜ 我的信箱"
    })
    <link rel="stylesheet" href="./css/message.css">
</head>
<body>
    @@include('./layout/header.html')
    <section>
        <div id="blackListAlert" class="md-modal md-effect-1">
            <form method="POST" class="md-content">
                <p>設定為黑名單後即無法傳送私信給此用戶，並無法收到此用戶傳來的私信，是否確認將此用戶設為黑名單？</p>
                <button class="yes titleFont">確認</button>
                <button class="cancel titleFont md-close">取消</button>
            </form>
        </div>
        <div id="deleteAlert">
            <form method="POST">
                <p>是否確認刪除此筆私信？</p>
                <button class="yes titleFont">確認</button>
                <button class="cancel titleFont">取消</button>
            </form>
        </div>
        <div id="imgAlert">
            <form method="POST" enctype="multipart/form-data">
                <button></button>
                <img id="imgPanel">
                <input type="submit" value="" id="submitImg">
            </form>
        </div>
        <div id="showImgAlert">
            <div>
                <button></button>
                <img id="showImgPanel">
                <a href="" download=""></a>
            </div>
        </div>
        <aside class="col-xl-4 col-lg-4 col-md-5 col-sm-12 col-ss-12">
            <div class="myMessage">
                <h2>我的信箱</h2>
                <span class="titleFont"></span><!--幾則未讀-->
            </div>
            <ul class="aside">
                
            </ul>
        </aside>
        <main class="col-xl-8 col-lg-8 col-md-7 col-sm-12 col-ss-12">
            <ul>
                <button class="back titleFont"></button>
            </ul>
            <form method="POST" class="edit" enctype="multipart/form-data">
                <label for="upload">
                    <input type="file" id="upload" name="upload" accept="image/*">
                </label>
                <input type="text" id="inputText" name="inputText" placeholder="請輸入私信內容">
                <input type="submit" id="submitText" value="">
            </form>
        </main>
    </section>
    <script src="./js/heightWithoutHeader.js"></script>
    <script src="./js/hamburger.js"></script>
    <script src="./js/memberHeader.js"></script>
    <script src="./js/signInOut.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
    <script>
        sectionHeight();
        window.addEventListener('resize',sectionHeight);

        var aside= document.querySelector('aside');
        var main= document.querySelector('main');  

        // main.style.backgroundImage= `url(./img/msgBg/${1+Math.floor(Math.random()*10)}.jpg)`;
        
        function changeSide(e){
            if(document.body.clientWidth<=767){
                if(main.style.display=='none'){
                    aside.style.width= '0%';
                    main.style.display= 'block';
                    main.style.width= '100%';
                }else{
                    aside.style.width= '100%';
                    main.style.display= 'none';
                }
            }
        }

        window.addEventListener('resize',function(){
            //md
            if(document.body.clientWidth>=768 && document.body.clientWidth<=991){
                aside.style.width= 'calc(100% / 12 * 5)';
                main.style.display= 'block';
                main.style.width= 'calc(100% / 12 * 7)';

            //lg
            }else if(document.body.clientWidth>=992 && document.body.clientWidth<=1199){
                aside.style.width= 'calc(100% / 12 * 4)';
                main.style.display= 'block';
                main.style.width= 'calc(100% / 12 * 8)';

            //xl
            }else if(document.body.clientWidth>=1200){
                aside.style.width= 'calc(100% / 12 * 4)';
                main.style.display= 'block';
                main.style.width= 'calc(100% / 12 * 8)';

            //sm
            }else if(document.body.clientWidth>=576 && document.body.clientWidth<=767){
                aside.style.width= '100%';
                main.style.display= 'none';
                main.style.width= '100%';

            //ss
            }else if(document.body.clientWidth<=575){
                aside.style.width= '100%';
                main.style.display= 'none';
                main.style.width= '100%';
            }
        });


        //我的信箱右邊顯示共幾則未讀
        function showTotalUnread(){
            var unreads= document.querySelectorAll("aside li.unRead p span");
            var amt=0;
            for(var i=0; i<unreads.length; i++){
                amt+= parseInt(unreads[i].innerText);
            }
            document.querySelector("aside div.myMessage span").innerText= `${amt}則未讀`;
            getMember();
        }
        showTotalUnread();

        //上傳圖片
        let imgAlert= document.getElementById("imgAlert");
        imgAlert.querySelector("button").addEventListener("click",function(e){
            e.preventDefault();
            imgAlert.style.display="none";
        });
        let upload= document.getElementById("upload");
        upload.disabled=true;
        upload.addEventListener("change",function(e){
            if(e.target.files[0]){
                imgAlert.style.display="block";
                let file= e.target.files[0];
                let readFile= new FileReader();
                readFile.readAsDataURL(file);
                readFile.addEventListener('load',function(e){
                    document.getElementById("imgPanel").src= e.target.result;
                });
            }
        });
        let submitImg= document.getElementById("submitImg");
        submitImg.addEventListener("click",function(e){
            e.preventDefault();
            var formData= new FormData();
            formData.append("uploadImg",upload.files[0]);
            formData.append("getMemNo",document.querySelector("aside ul li.on").classList[0].substr(2));
            $.ajax({
                url: './php/uploadImg.php',
                cache: false,
                contentType: false,
                processData: false,
                data: formData,                 
                type: 'post',
                success: function(data){
                    if(data.indexOf("error")==-1){
                        imgAlert.style.display="none";
                        showAllMsg(document.querySelector("aside ul li.on").classList[0].substr(2));
                        document.querySelector("aside ul").innerHTML="";
                        getMsg();
                    }else{
                        alert(data.split("|")[1]);
                    }
                },
                error: function(data){
                    alert(data);
                }
            });
        });

        
        //送出文字私信，新增至資料庫
        function addTextMsg(e){
            e.preventDefault();
            var xhr= new XMLHttpRequest();
            var url= "./php/addTextMsg.php";
            xhr.open("POST",url,true);
            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
            var getMemNo= document.querySelector("aside ul li.on").classList[0].substr(2);

            var inputVal=document.getElementById("inputText").value;
            
            var data_info= `getMemNo=${getMemNo}&msgText=${encodeURIComponent(inputVal)}`;
            xhr.send(data_info);
            console.log(encodeURIComponent(inputVal));
            xhr.onload=function(){
                if(xhr.status==200){
                    showAllMsg(document.querySelector("aside ul li.on").classList[0].substr(2));
                    document.querySelector("aside ul").innerHTML="";
                    getMsg();
                    document.getElementById("inputText").value="";
                    document.getElementById("submitText").disabled=true;
                }else{
                    alert(xhr.status);
                }
            }
        }
        let submitText= document.getElementById("submitText");
        submitText.disabled=true;
        

        var theAmt="";
        //取得左邊列表要顯示的未讀數量
        function unReadAmt(sendMemNo){
            var xhr= new XMLHttpRequest();
            var url= "./php/unReadAmt.php";
            xhr.open("POST",url,true);
            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
            var data_info= "sendMemNo="+sendMemNo;
            xhr.send(data_info);
            
            xhr.onload=function(){
                if(xhr.status==200){
                    theAmt= xhr.responseText;
                    document.querySelector(`li.No${sendMemNo}.unRead div.text p span`).innerText= theAmt;
                    showTotalUnread();
                }else{
                    alert(xhr.status);
                }
            }
        }

            
        //秀出左邊列表
        function showMsgList(xmlDoc){
            var fields= xmlDoc.documentElement.childNodes;//members>member
            for(var i=0; i<fields.length; i++){
                var li= document.createElement("li");
                var myMemNo= fields[i].getElementsByTagName("myMemNo")[0].firstChild.nodeValue;
                var sendMemNo= fields[i].getElementsByTagName("sendMemNo")[0].firstChild.nodeValue;
                var getMemNo= fields[i].getElementsByTagName("getMemNo")[0].firstChild.nodeValue;
                if(myMemNo==sendMemNo){
                    li.className= "No"+getMemNo;
                }else{
                    li.className= "No"+sendMemNo;
                }

                if(myMemNo!=sendMemNo){
                    var readOrNot= fields[i].getElementsByTagName("readOrNot")[0].firstChild.nodeValue;
                    if(readOrNot==0){
                        li.classList.add("unRead");
                    }
                }
                
                var divImg= document.createElement("div");
                divImg.className= "img";
                li.appendChild(divImg);
                var img= document.createElement("img");
                var listMemPic;
                if(myMemNo==sendMemNo){
                    listMemPic= fields[i].getElementsByTagName("getMemPic")[0].firstChild.nodeValue;
                }else{
                    listMemPic= fields[i].getElementsByTagName("sendMemPic")[0].firstChild.nodeValue;
                }
                img.src=`./img/memImg/${listMemPic}`;
                divImg.appendChild(img);

                var divText= document.createElement("div");
                divText.className="text";
                var divTitle= document.createElement("div");
                divTitle.className="title";
                divText.appendChild(divTitle);
                var h4= document.createElement("h4");

                var listMemName;
                if(myMemNo==sendMemNo){
                    listMemName= fields[i].getElementsByTagName("getMemName")[0].firstChild.nodeValue;
                }else{
                    listMemName= fields[i].getElementsByTagName("sendMemName")[0].firstChild.nodeValue;
                }
                var h4Text= document.createTextNode(listMemName);
                h4.appendChild(h4Text);

                var span= document.createElement("span");
                var sendTime= fields[i].getElementsByTagName("msgTime")[0].firstChild.nodeValue;
                var spanText= document.createTextNode(sendTime.split(" ")[0]+"　"+sendTime.split(" ")[1].split(":")[0]+":"+sendTime.split(" ")[1].split(":")[1]);
                span.appendChild(spanText);
                span.className="smalltext";
                divTitle.appendChild(h4);
                divTitle.appendChild(span);
                var p= document.createElement("p");
                if(!fields[i].getElementsByTagName("msgText")[0].firstChild && !fields[i].getElementsByTagName("msgPic")[0].firstChild){
                    var latestMsg= "";
                }else if (fields[i].getElementsByTagName("msgText")[0].firstChild && !fields[i].getElementsByTagName("msgPic")[0].firstChild){
                    var latestMsg=fields[i].getElementsByTagName("msgText")[0].firstChild.nodeValue;
                }else if (!fields[i].getElementsByTagName("msgText")[0].firstChild && fields[i].getElementsByTagName("msgPic")[0].firstChild){
                    var latestMsg= "傳送一張圖片";
                }
                var pText= document.createTextNode(latestMsg);
                p.appendChild(pText);

                if(li.classList.contains("unRead")){
                    var unSpan= document.createElement("span");
                    if(myMemNo==sendMemNo){
                        unReadAmt(fields[i].getElementsByTagName("getMemNo")[0].firstChild.nodeValue);
                    }else{
                        unReadAmt(fields[i].getElementsByTagName("sendMemNo")[0].firstChild.nodeValue);
                    }
                    unSpan.innerText= theAmt;
                    p.appendChild(unSpan);
                }

                divText.appendChild(p);
                li.appendChild(divText);
                var ulAside= document.querySelector("ul.aside");
                ulAside.insertBefore(li,ulAside.firstChild);
                var ulAsideLis= document.querySelectorAll(`aside ul li.No${myMemNo==sendMemNo?getMemNo:sendMemNo}`);

                for(var j=0; j<ulAsideLis.length; j++){
                    ulAsideLis[j].onclick=function(e){
                        showAllMsg(this.classList[0].substr(2));
                        changeUnRead(this.classList[0].substr(2));
                        this.classList.add("on");
                        sessionStorage.setItem("now-on",this.classList[0].substr(2));
                        $("aside ul li").not(this).removeClass("on");
                        if(this.classList.contains("unRead")){ 
                            this.querySelector("div.text p").removeChild(this.querySelector("div.text p span"));
                            this.classList.remove("unRead");
                        }
                        showTotalUnread();
                        document.getElementById("upload").disabled=false;
                        
                        document.getElementById("inputText").addEventListener("input",function(){
                            if(document.getElementById("inputText").value==""){
                                submitText.disabled=true;
                            }else{
                                submitText.disabled=false;
                                submitText.addEventListener("click",addTextMsg);
                            }
                        })
                    }
                }

                var chatRooms= document.querySelectorAll('aside ul li');
                for(let i=0; i<chatRooms.length; i++){
                    chatRooms[i].addEventListener('click',changeSide);
                }
            }
        }

        //點擊左邊列表，變更訊息的readOrNot
        function changeUnRead(sendMemNo){
            var xhr= new XMLHttpRequest();
            var url= "./php/changeUnRead.php";
            xhr.open("POST",url,true);
            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
            var data_info= "sendMemNo="+sendMemNo;
            xhr.send(data_info);
            xhr.onload=function (){
                if(xhr.status!=200){
                    alert(xhr.status);
                }
            };
        }

        //取得左邊列表
        function getMsg(){
            var xhr= new XMLHttpRequest();
            var url= "./php/LatestMessage.php";
            xhr.open("POST",url,true);
            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
            var data_info= "";
            xhr.send(data_info);
            xhr.onload=function (){
                if(xhr.status==200){
                    if(xhr.responseText.indexOf("notFound")==-1){
                        showMsgList(xhr.responseXML);
                        if(sessionStorage.getItem("now-on")){
                            var nowOn= document.querySelector(`aside ul li.No${sessionStorage.getItem("now-on")}`);
                            nowOn.classList.add("on");
                            document.querySelector("aside ul li.on").onclick();
                        }
                    }else{
                        // alert("尚無私信內容");
                        document.querySelector("aside ul").innerHTML=`
                        <div id="withoutMsg">
                            <div class="img">
                                <p class="bubble">尚無私信內容</p>
                                <img src="./img/yuru_neko6.png">
                            </div>
                            <div class="text">
                                <p>立即前往</p>
                                <div>
                                    <a href="./map.html">浪浪在哪裡</a><img src="./img/pawprint-01.svg">
                                    <a href="./post_article_region.html">毛孩交流區</a>
                                </div>
                                <p>開始體驗私信吧！</p>
                            </div>
                        </div>`;
                    }
                }else{
                    alert(xhr.status);
                }
            };
        }
        getMsg();

        //右邊的顯示內容
        function showPanel(xmlDoc){
            var fields= xmlDoc.documentElement.childNodes;//members>member
            var ulMain= document.querySelector('main ul');
            ulMain.innerHTML=`
            <button class="back titleFont"></button>
                <div id="setBlackZone">
                    <button id="setting"></button>
                    <span id="setBlack">設為黑名單</span>
                </div>
            `;
            var setBlackZone= document.getElementById("setBlackZone");
            var setting= document.getElementById("setting");
            var setBlack= document.getElementById("setBlack");
            var blackListAlert= document.getElementById("blackListAlert");
            var btnBack= document.querySelector('button.back');
            setBlackZone.style.top= document.querySelector('nav').offsetHeight + 10 + "px";
            window.addEventListener('resize',function(){
                setBlackZone.style.top= document.querySelector('nav').offsetHeight + 10 + "px";
            });
            setting.addEventListener("click",function(){
                setBlack.classList.toggle("on");
            });
            setBlack.addEventListener("click",function(){
                setBlack.classList.toggle("on");
                blackListAlert.style.display="block";
            });
            blackListAlert.querySelector('button.cancel').onclick=function(e){
                e.preventDefault();
                blackListAlert.style.display="none";
            };
            blackListAlert.querySelector('button.yes').onclick=function(e){
                e.preventDefault();
                blackListAlert.style.display="none";
                var xhr= new XMLHttpRequest();
                xhr.open("POST","./php/setBlack.php",true);
                xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
                var data_info= `blackMemNo=${document.querySelector("aside ul li.on").classList[0].substr(2)}`;
                xhr.send(data_info);
                xhr.onload= function(){
                    if(xhr.status==200){
                        if(xhr.responseText.indexOf("ok")!=-1){
                            alert("已將此會員設為黑名單");
                            // showAllMsg(document.querySelector("aside ul li.on").classList[0].substr(2));
                            if(document.body.clientWidth<=767){
                                aside.style.width= '100%';
                                main.style.display= 'none';
                                main.style.width= '100%';
                            }
                            main.innerHTML=`<ul>
                                <button class="back titleFont"></button>
                            </ul>
                            <form method="POST" class="edit" enctype="multipart/form-data">
                                <label for="upload">
                                    <input type="file" id="upload" name="upload" accept="image/*">
                                </label>
                                <input type="text" id="inputText" name="inputText" placeholder="請輸入私信內容">
                                <input type="submit" id="submitText" value="">
                            </form>`;
                            document.querySelector("aside ul").innerHTML="";
                            getMsg();
                            if(document.querySelector("aside ul li.on")){
                                document.querySelector("aside ul li.on").className.remove("on");
                            }
                            sessionStorage.removeItem("now-on");
                            
                        }else{  
                            alert("設定失敗，請再試一次");
                        }
                    }else{
                        alert(xhr.status);
                    }
                }
            };
            btnBack.addEventListener('click',changeSide);
            for(var i=0; i<fields.length; i++){
                if(fields[i].getElementsByTagName("msgText")[0].firstChild || fields[i].getElementsByTagName("msgPic")[0].firstChild){
                    var li= document.createElement("li");
                    var myMemNo= fields[i].getElementsByTagName("myMemNo")[0].firstChild.nodeValue;
                    var sendMemNo= fields[i].getElementsByTagName("sendMemNo")[0].firstChild.nodeValue;

                    if(myMemNo != sendMemNo){
                        li.className="otherSide";
                    }else{
                        li.className="self";
                    }
                    if(li.className=="otherSide"){
                        var divImg= document.createElement("div");
                        divImg.className="img";
                        li.appendChild(divImg);
                        var img= document.createElement("img");
                        var sendMemPic= fields[i].getElementsByTagName("sendMemPic")[0].firstChild.nodeValue;
                        img.src=`./img/memImg/${sendMemPic}`;//寄件人的圖片
                        divImg.appendChild(img);
                        var h4= document.createElement("h4");
                        var sendMemName= fields[i].getElementsByTagName("sendMemName")[0].firstChild.nodeValue;
                        var h4Text= document.createTextNode(sendMemName);
                        h4.appendChild(h4Text);
                        li.appendChild(h4);
                    }
                    var divText= document.createElement("div");
                    divText.className="text";
                    li.appendChild(divText);
                    if(li.className=="otherSide"){
                        var h4= document.createElement("h4");
                        var sendMemName= fields[i].getElementsByTagName("sendMemName")[0].firstChild.nodeValue;
                        var h4Text= document.createTextNode(sendMemName);
                        h4.appendChild(h4Text);
                        divText.appendChild(h4);
                    }
                    if(!fields[i].getElementsByTagName("msgPic")[0].firstChild){
                        var p= document.createElement("p");
                        var pText= fields[i].getElementsByTagName("msgText")[0].firstChild.nodeValue;
                        var pNode= document.createTextNode(pText);
                        p.appendChild(pNode);
                        divText.appendChild(p);
                    }else{
                        var img= document.createElement("img");
                        img.src= `./img/msgPic/${fields[i].getElementsByTagName("msgPic")[0].firstChild.nodeValue}`;
                        img.width= 200;
                        img.className="msgPic";
                        divText.appendChild(img);
                    }
                    var span= document.createElement("span");
                    span.className="smalltext";
                    var msgTime= fields[i].getElementsByTagName("msgTime")[0].firstChild.nodeValue;
                    var spanText= document.createTextNode(msgTime.split(" ")[0]+"　"+msgTime.split(" ")[1].split(":")[0]+":"+msgTime.split(" ")[1].split(":")[1]);
                    span.appendChild(spanText);
                    divText.appendChild(span);
                    var button= document.createElement("button");
                    button.className="closeBtn";
                    button.classList.add(`No${fields[i].getElementsByTagName("msgNo")[0].firstChild.nodeValue}`);
                    divText.appendChild(button);
                    ulMain.appendChild(li);

                    //下載圖片
                    var liImgs= document.querySelectorAll("img.msgPic");
                    var showImgAlert= document.getElementById("showImgAlert");
                    function browserIsIe() {
                        if (!!window.ActiveXObject || "ActiveXObject" in window){
                            return true;
                        }
                        else{
                            return false;
                        }
                    }
                    function createIframe(imgSrc) {
                        if ($("#IframeReportImg").length === 0){
                            $('<iframe style="display:none;" id="IframeReportImg" name="IframeReportImg" onload="downloadImg();" width="0" height="0" src="about:blank"></iframe>').appendTo("body");
                        }
                        if ($('#IframeReportImg').attr("src") != imgSrc) {
                            $('#IframeReportImg').attr("src",imgSrc);
                        } else {
                            downloadImg();
                        }
                    }
                    function downloadImg() {
                        if ($('#IframeReportImg').src != "about:blank") {
                            window.frames["IframeReportImg"].document.execCommand("SaveAs");
                        }
                    }
                    
                   
                    for(var i=0; i<liImgs.length; i++){
                        liImgs[i].onclick=function(e){
                            showImgAlert.style.display="block";
                            showImgAlert.querySelector("img").src=this.src;
                            if (browserIsIe()) {
                                var imgSrc = $(this).attr("src");
                                createIframe(imgSrc);
                            } else {
                                showImgAlert.querySelector("a").href=this.src;
                                showImgAlert.querySelector("a").download=this.split("_").pop();
                            }
                        }
                    }
                    showImgAlert.querySelector("button").onclick=function(){
                        showImgAlert.style.display="none";
                    }



                    //刪除訊息
                    var closeBtns= document.querySelectorAll('button.closeBtn');
                    var deleteAlert= document.getElementById("deleteAlert");
                    for(var i=0; i<closeBtns.length; i++){
                        closeBtns[i].onclick=function(){
                            deleteAlert.style.display="block";
                            sessionStorage.setItem("delMsgNo",this.classList[1].substr(2));
                        }
                    }
                    deleteAlert.querySelector('button.cancel').onclick=function(e){
                        e.preventDefault();
                        deleteAlert.style.display="none";
                    }
                    deleteAlert.querySelector('button.yes').onclick=function(e){
                        e.preventDefault();
                        deleteAlert.style.display="none";
                        var xhr= new XMLHttpRequest();
                        var url= "./php/deleteMsg.php";
                        xhr.open("POST",url,true);
                        xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
                        var data_info=`delMsgNo=${sessionStorage.getItem("delMsgNo")}`;
                        xhr.send(data_info);
                        xhr.onload= function(){
                            if(xhr.status==200){
                                // alert("成功刪除一筆私信");
                                showAllMsg(document.querySelector("aside ul li.on").classList[0].substr(2));
                                document.querySelector("aside ul").innerHTML="";
                                getMsg();
                            }else{
                                alert(xhr.status);
                            }
                        }
                    }
                }
                
            }
            var mainUl= document.querySelector("main ul");
            mainUl.scroll(0,mainUl.scrollHeight);
        }

        //按左邊列表顯示在右邊
        function showAllMsg(sendMemNo){
            var xhr= new XMLHttpRequest();
            var url= "./php/showAllMsg.php";
            xhr.open("POST",url,true);
            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
            var data_info= `sendMemNo=${sendMemNo}`;
            xhr.send(data_info);

            xhr.onload=function(){
                if(xhr.status==200){
                    showPanel(xhr.responseXML);
                }else{
                    alert(xhr.status);
                }
            };
        }



    </script>
</body>
</html>
